# Saassy - Production Docker Compose
# Usage: docker compose -f docker-compose.prod.yml up -d

services:
  # ===========================================
  # PocketBase - Auth, Database, Admin UI
  # ===========================================
  pocketbase:
    image: ghcr.io/muchobien/pocketbase:latest
    container_name: saassy-pocketbase
    restart: always
    expose:
      - "8090"
    volumes:
      - pocketbase_data:/pb_data
      - ./data/pocketbase/pb_migrations:/pb_migrations:ro
    environment:
      - PB_ENCRYPTION_KEY=${PB_ENCRYPTION_KEY}
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://localhost:8090/api/health || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pocketbase.rule=Host(`api.${DOMAIN}`)"
      - "traefik.http.routers.pocketbase.tls=true"
      - "traefik.http.routers.pocketbase.tls.certresolver=letsencrypt"
      - "traefik.http.services.pocketbase.loadbalancer.server.port=8090"

  # ===========================================
  # Redis - Job Queue
  # ===========================================
  redis:
    image: redis:7-alpine
    container_name: saassy-redis
    restart: always
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    expose:
      - "6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: redis-cli ping
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================
  # Web App - Next.js Frontend
  # ===========================================
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
      target: production
    container_name: saassy-web
    restart: always
    expose:
      - "3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_POCKETBASE_URL=https://api.${DOMAIN}
      - POCKETBASE_URL=http://pocketbase:8090
      - REDIS_URL=redis://redis:6379
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
    depends_on:
      pocketbase:
        condition: service_healthy
      redis:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.web.rule=Host(`${DOMAIN}`) || Host(`www.${DOMAIN}`)"
      - "traefik.http.routers.web.tls=true"
      - "traefik.http.routers.web.tls.certresolver=letsencrypt"
      - "traefik.http.services.web.loadbalancer.server.port=3000"

  # ===========================================
  # Worker Manager - Docker Orchestration
  # ===========================================
  worker-manager:
    build:
      context: ./services/worker-manager
      dockerfile: Dockerfile
      target: production
    container_name: saassy-worker-manager
    restart: always
    expose:
      - "3001"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - NODE_ENV=production
      - POCKETBASE_URL=http://pocketbase:8090
      - REDIS_URL=redis://redis:6379
      - INTERNAL_API_KEY=${INTERNAL_API_KEY}
      - WORKER_NETWORK=saassy-workers
      - MAX_CONCURRENT_WORKERS=${MAX_CONCURRENT_WORKERS:-10}
    depends_on:
      pocketbase:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ===========================================
  # Billing Service - Usage & Stripe
  # ===========================================
  billing:
    build:
      context: ./services/billing
      dockerfile: Dockerfile
      target: production
    container_name: saassy-billing
    restart: always
    expose:
      - "3002"
    environment:
      - NODE_ENV=production
      - POCKETBASE_URL=http://pocketbase:8090
      - REDIS_URL=redis://redis:6379
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      - INTERNAL_API_KEY=${INTERNAL_API_KEY}
    depends_on:
      pocketbase:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ===========================================
  # Traefik - Reverse Proxy & SSL
  # ===========================================
  traefik:
    image: traefik:v3.0
    container_name: saassy-traefik
    restart: always
    command:
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_certs:/letsencrypt
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.${DOMAIN}`)"
      - "traefik.http.routers.dashboard.tls=true"
      - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.middlewares=auth"
      - "traefik.http.middlewares.auth.basicauth.users=${TRAEFIK_AUTH}"

# ===========================================
# Networks
# ===========================================
networks:
  default:
    name: saassy-network
  workers:
    name: saassy-workers
    driver: bridge

# ===========================================
# Volumes
# ===========================================
volumes:
  pocketbase_data:
  redis_data:
  traefik_certs:
